name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      - name: Lint sashi CLI
        run: shellcheck -x -s bash sashi || true
      - name: Lint lib scripts
        run: find lib/ -name '*.sh' -exec shellcheck -x -s bash {} + 2>/dev/null || true

  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: docker build -t kanban-pmo:test .
      - name: Validate compose
        run: docker compose config --quiet

  structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate kanban board dirs
        run: |
          for dir in kanban/backlog kanban/open kanban/wip kanban/closed; do
            test -d "$dir" && echo "OK: $dir" || echo "MISSING: $dir"
          done
      - name: Check sashi executable
        run: test -x sashi && bash -n sashi
      - name: Validate install script
        run: bash -n install.sh
