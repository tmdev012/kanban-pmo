# Workflow: cred-audit
# Prefix: cred | Suffix: audit
# Audit: Scans for credential leaks and validates .env safety
name: cred-audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  cred-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for leaked secrets
        run: |
          echo "=== Credential Audit ==="
          FAIL=0
          # Check no .env committed
          if git ls-files --error-unmatch .env 2>/dev/null; then
            echo "::error::.env is tracked â€” REMOVE IMMEDIATELY"
            FAIL=1
          fi
          # Check no private keys
          if git ls-files | grep -iE '\.pem$|\.key$|id_rsa|id_ed25519$'; then
            echo "::error::Private key file detected in repo"
            FAIL=1
          fi
          # Check no hardcoded tokens
          if grep -rI 'sk-or-\|ghp_\|gho_\|glpat-\|AKIA' --include='*.sh' --include='*.py' --include='*.yml' .; then
            echo "::error::Hardcoded token detected"
            FAIL=1
          fi
          [ $FAIL -eq 0 ] && echo "PASS: No credential leaks detected"
          exit $FAIL

      - name: Log audit trail
        run: |
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) cred-audit scan completed" >> kanban/exports/audit.log
